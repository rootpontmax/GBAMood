#include "Console.h"
#include "Graphics.h"

#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>



////////////////////////////////////////////////////////////////////////////////////////////////////
#define MAX_MESSAGE_SIZE 128
////////////////////////////////////////////////////////////////////////////////////////////////////
const uint16_t *g_pConsoleFont[] __attribute__((aligned(2))) =
{
 0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x0000 ,0x0000 ,0x0000
,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x0000 ,0x0000 ,0x0000
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x7c44 ,0x4444 ,0x447c ,0x0000 ,0x7c44 ,0x4444 ,0x447c
,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000
,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000
,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0c0c ,0x0c0c ,0x0c00 ,0x0c00
,0x3333 ,0x0000 ,0x0000 ,0x0000 ,0x3636 ,0x7f36 ,0x7f36 ,0x3600
,0x0c1f ,0x301e ,0x033e ,0x0c00 ,0x0033 ,0x566c ,0x1b35 ,0x6600
,0x386c ,0x6876 ,0xdcce ,0x7b00 ,0x0c0c ,0x0000 ,0x0000 ,0x0000
,0x0c18 ,0x3030 ,0x3018 ,0x0c00 ,0x3018 ,0x0c0c ,0x0c18 ,0x3000
,0x0033 ,0x1e3f ,0x1e33 ,0x0000 ,0x000c ,0x0c3f ,0x0c0c ,0x0000
,0x0000 ,0x0000 ,0x000c ,0x0c18 ,0x0000 ,0x003f ,0x0000 ,0x0000
,0x0000 ,0x0000 ,0x000c ,0x0c00 ,0x0306 ,0x0c18 ,0x3060 ,0xc000
,0x1e33 ,0x373f ,0x3b33 ,0x1e00 ,0x0c1c ,0x3c0c ,0x0c0c ,0x0c00
,0x1e33 ,0x0306 ,0x0c18 ,0x3f00 ,0x1e33 ,0x030e ,0x0333 ,0x1e00
,0x0e1e ,0x3666 ,0x7f06 ,0x0600 ,0x3f30 ,0x3e03 ,0x0333 ,0x1e00
,0x0e18 ,0x303e ,0x3333 ,0x1e00 ,0x3f03 ,0x0306 ,0x0c0c ,0x0c00
,0x1e33 ,0x331e ,0x3333 ,0x1e00 ,0x1e33 ,0x331f ,0x0306 ,0x1c00
,0x000c ,0x0c00 ,0x000c ,0x0c00 ,0x000c ,0x0c00 ,0x000c ,0x0c18
,0x0000 ,0x030c ,0x300c ,0x0300 ,0x0000 ,0x003f ,0x003f ,0x0000
,0x0000 ,0x300c ,0x030c ,0x3000 ,0x1e33 ,0x0306 ,0x0c00 ,0x0c00
,0x3e63 ,0x6f6b ,0x6f60 ,0x3c00 ,0x1e33 ,0x333f ,0x3333 ,0x3300
,0x3e33 ,0x333e ,0x3333 ,0x3e00 ,0x0f18 ,0x3030 ,0x3018 ,0x0f00
,0x3c36 ,0x3333 ,0x3336 ,0x3c00 ,0x3f30 ,0x303c ,0x3030 ,0x3f00
,0x3f30 ,0x303c ,0x3030 ,0x3000 ,0x1e33 ,0x3037 ,0x3333 ,0x1f00
,0x3333 ,0x333f ,0x3333 ,0x3300 ,0x1e0c ,0x0c0c ,0x0c0c ,0x1e00
,0x0303 ,0x0303 ,0x0333 ,0x1e00 ,0x6366 ,0x6c78 ,0x6c66 ,0x6300
,0x3030 ,0x3030 ,0x3030 ,0x3f00 ,0x6377 ,0x7f6b ,0x6363 ,0x6300
,0x6373 ,0x7b6f ,0x6763 ,0x6300 ,0x1e33 ,0x3333 ,0x3333 ,0x1e00
,0x3e33 ,0x333e ,0x3030 ,0x3000 ,0x3c66 ,0x6666 ,0x666e ,0x3f00
,0x3e33 ,0x333e ,0x3633 ,0x3300 ,0x1e33 ,0x381e ,0x0733 ,0x1e00
,0x3f0c ,0x0c0c ,0x0c0c ,0x0c00 ,0x3333 ,0x3333 ,0x3333 ,0x1e00
,0x3333 ,0x3333 ,0x1e1e ,0x0c00 ,0x6363 ,0x636b ,0x7f77 ,0x6300
,0xc366 ,0x3c18 ,0x3c66 ,0xc300 ,0xc366 ,0x3c18 ,0x1818 ,0x1800
,0x3f06 ,0x0c18 ,0x3060 ,0x7f00 ,0x1e18 ,0x1818 ,0x1818 ,0x1e00
,0xc060 ,0x3018 ,0x0c06 ,0x0300 ,0x1e06 ,0x0606 ,0x0606 ,0x1e00
,0x000c ,0x3300 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x007f
,0x0c0c ,0x0600 ,0x0000 ,0x0000 ,0x0000 ,0x1e03 ,0x1f33 ,0x1f00
,0x3030 ,0x3e33 ,0x3333 ,0x3e00 ,0x0000 ,0x1e30 ,0x3030 ,0x1e00
,0x0303 ,0x1f33 ,0x3333 ,0x1f00 ,0x0000 ,0x1e33 ,0x3f30 ,0x1e00
,0x0e18 ,0x3e18 ,0x1818 ,0x1800 ,0x0000 ,0x1f33 ,0x331f ,0x031e
,0x3030 ,0x3e33 ,0x3333 ,0x3300 ,0x0c00 ,0x0c0c ,0x0c0c ,0x0600
,0x0600 ,0x0606 ,0x0606 ,0x063c ,0x3030 ,0x3336 ,0x3c36 ,0x3300
,0x0c0c ,0x0c0c ,0x0c0c ,0x0600 ,0x0000 ,0x767f ,0x6b63 ,0x6300
,0x0000 ,0x3e33 ,0x3333 ,0x3300 ,0x0000 ,0x1e33 ,0x3333 ,0x1e00
,0x0000 ,0x3e33 ,0x333e ,0x3030 ,0x0000 ,0x1f33 ,0x331f ,0x0303
,0x0000 ,0x3e33 ,0x3030 ,0x3000 ,0x0000 ,0x1e30 ,0x1e03 ,0x3e00
,0x1818 ,0x3e18 ,0x1818 ,0x0e00 ,0x0000 ,0x3333 ,0x3333 ,0x1f00
,0x0000 ,0x3333 ,0x331e ,0x0c00 ,0x0000 ,0x6363 ,0x6b7f ,0x3600
,0x0000 ,0x6336 ,0x1c36 ,0x6300 ,0x0000 ,0x3333 ,0x331e ,0x0c18
,0x0000 ,0x3f06 ,0x0c18 ,0x3f00 ,0x0c1c ,0x1838 ,0x3818 ,0x1c0c
,0x1818 ,0x1818 ,0x1818 ,0x1818 ,0x3038 ,0x181c ,0x1c18 ,0x3830
,0x3f00 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x001e ,0x307e ,0x7c30 ,0x1e00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x330c ,0x1e30 ,0x1e03 ,0x3e00 ,0x0000 ,0x0c18 ,0x3018 ,0x0c00
,0x0000 ,0x1f24 ,0x2624 ,0x1f00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0018 ,0x1000 ,0x0000 ,0x0000
,0x000c ,0x1800 ,0x0000 ,0x0000 ,0x0036 ,0x2400 ,0x0000 ,0x0000
,0x0036 ,0x6c00 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x006a ,0x4c6a ,0x0000 ,0x0000
,0x330c ,0x1e30 ,0x1e03 ,0x3e00 ,0x0000 ,0x380c ,0x060c ,0x3800
,0x0000 ,0x1f24 ,0x2624 ,0x1f00 ,0x0000 ,0x0000 ,0x0000 ,0x0c00
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0xc300 ,0xe77e ,0x3c18 ,0x1800
,0x0000 ,0x0000 ,0x0000 ,0x0c00 ,0x000c ,0x000c ,0x0c0c ,0x0c00
,0x0002 ,0x1e30 ,0x3030 ,0x1e10 ,0x0e1b ,0x183c ,0x1818 ,0x3f00
,0x003f ,0x123f ,0x0000 ,0x0000 ,0x331e ,0x3f0c ,0x3f0c ,0x0c00
,0x0c0c ,0x0c00 ,0x0c0c ,0x0c00 ,0x1e30 ,0x1e33 ,0x1e03 ,0x1e00
,0x0033 ,0x0000 ,0x0000 ,0x0000 ,0x3e41 ,0x5d51 ,0x5d41 ,0x3e00
,0x1804 ,0x1c24 ,0x1c00 ,0x3c00 ,0x0000 ,0x3366 ,0xcc66 ,0x3300
,0x0000 ,0x003c ,0x0400 ,0x0000 ,0x0000 ,0x003c ,0x0000 ,0x0000
,0x3e41 ,0x595d ,0x5541 ,0x3e00 ,0x3f00 ,0x0000 ,0x0000 ,0x0000
,0x001e ,0x0c00 ,0x0000 ,0x0000 ,0x0c0c ,0x3f0c ,0x0c00 ,0x3f00
,0x0018 ,0x0408 ,0x1c00 ,0x0000 ,0x0018 ,0x040c ,0x1800 ,0x0000
,0x001c ,0x0000 ,0x0000 ,0x0000 ,0x0000 ,0x0024 ,0x2424 ,0x3e20
,0x001f ,0x3a3a ,0x0a0a ,0x0a00 ,0x0000 ,0x0018 ,0x1800 ,0x0000
,0x0000 ,0x0000 ,0x0006 ,0x3c00 ,0x0008 ,0x1808 ,0x1c00 ,0x0000
,0x0018 ,0x2424 ,0x1800 ,0x0000 ,0x0000 ,0xcc66 ,0x3366 ,0xcc00
,0x4044 ,0x4810 ,0x2a4e ,0x8200 ,0x4044 ,0x4810 ,0x2e44 ,0x8e00
,0xc024 ,0x68d0 ,0x2a4e ,0x8200 ,0x0c00 ,0x0c18 ,0x3033 ,0x1e00
,0x0804 ,0x1e33 ,0x3f33 ,0x3300 ,0x0408 ,0x1e33 ,0x3f33 ,0x3300
,0x0c12 ,0x1e33 ,0x3f33 ,0x3300 ,0x0a14 ,0x1e33 ,0x3f33 ,0x3300
,0x3300 ,0x1e33 ,0x3f33 ,0x3300 ,0x0c12 ,0x1e33 ,0x3f33 ,0x3300
,0x0000 ,0x1f24 ,0x3e24 ,0x2700 ,0x0f18 ,0x3030 ,0x3018 ,0x0f06
,0x0804 ,0x3f30 ,0x3c30 ,0x3f00 ,0x0408 ,0x3f30 ,0x3c30 ,0x3f00
,0x0c12 ,0x3f30 ,0x3c30 ,0x3f00 ,0x3300 ,0x3f30 ,0x3c30 ,0x3f00
,0x0804 ,0x1e0c ,0x0c0c ,0x1e00 ,0x0408 ,0x1e0c ,0x0c0c ,0x1e00
,0x0c12 ,0x1e0c ,0x0c0c ,0x1e00 ,0x3300 ,0x1e0c ,0x0c0c ,0x1e00
,0x3c36 ,0x337b ,0x3336 ,0x3c00 ,0x0a14 ,0x737b ,0x6f67 ,0x6300
,0x0e1e ,0x3f33 ,0x3333 ,0x1e00 ,0x0804 ,0x1e33 ,0x3333 ,0x1e00
,0x0408 ,0x1e33 ,0x3333 ,0x1e00 ,0x0c12 ,0x1e33 ,0x3333 ,0x1e00
,0xc33c ,0x6666 ,0x6666 ,0x3c00 ,0x0063 ,0x361c ,0x3663 ,0x0000
,0x1e33 ,0x373f ,0x3b33 ,0x1e00 ,0x0804 ,0x3333 ,0x3333 ,0x1e00
,0x0408 ,0x3333 ,0x3333 ,0x1e00 ,0x0c12 ,0x3333 ,0x3333 ,0x1e00
,0x3300 ,0x3333 ,0x3333 ,0x1e00 ,0xcbd3 ,0xe77e ,0x3c18 ,0x1800
,0x0030 ,0x3e33 ,0x333e ,0x3030 ,0x1e33 ,0x3336 ,0x3333 ,0x3630
,0x0804 ,0x1e03 ,0x1f33 ,0x1f00 ,0x0408 ,0x1e03 ,0x1f33 ,0x1f00
,0x0c12 ,0x1e03 ,0x1f33 ,0x1f00 ,0x0a14 ,0x1e03 ,0x1f33 ,0x1f00
,0x3300 ,0x1e03 ,0x1f33 ,0x1f00 ,0x0c12 ,0x1e03 ,0x1f33 ,0x1f00
,0x0000 ,0x1b04 ,0x1e24 ,0x1b00 ,0x0000 ,0x1e30 ,0x3030 ,0x1e0c
,0x0804 ,0x1e33 ,0x3f30 ,0x1e00 ,0x0408 ,0x1e33 ,0x3f30 ,0x1e00
,0x0c12 ,0x1e33 ,0x3f30 ,0x1e00 ,0x0033 ,0x1e33 ,0x3f30 ,0x1e00
,0x0804 ,0x0c0c ,0x0c0c ,0x0600 ,0x0408 ,0x0c0c ,0x0c0c ,0x0600
,0x0c12 ,0x0c0c ,0x0c0c ,0x0600 ,0x0033 ,0x0c0c ,0x0c0c ,0x0600
,0x0018 ,0x041e ,0x3333 ,0x1e00 ,0x0a14 ,0x3e33 ,0x3333 ,0x3300
,0x1008 ,0x1e33 ,0x3333 ,0x1e00 ,0x0408 ,0x1e33 ,0x3333 ,0x1e00
,0x0c12 ,0x1e33 ,0x3333 ,0x1e00 ,0x0a14 ,0x1e33 ,0x3333 ,0x1e00
,0x0033 ,0x1e33 ,0x3333 ,0x1e00 ,0x0000 ,0x0c00 ,0x3f00 ,0x0c00
,0x0000 ,0x1e37 ,0x3f3b ,0x1e00 ,0x0804 ,0x3333 ,0x3333 ,0x1f00
,0x0408 ,0x3333 ,0x3333 ,0x1f00 ,0x0c12 ,0x3333 ,0x3333 ,0x1f00
,0x0033 ,0x3333 ,0x3333 ,0x1f00 ,0x0408 ,0x3333 ,0x331e ,0x0c18
,0x0030 ,0x3e33 ,0x333e ,0x3030 ,0x0033 ,0x3333 ,0x331e ,0x0c18

};
//*/
////////////////////////////////////////////////////////////////////////////////////////////////////
const uint8_t *g_pCharTable = (const uint8_t *)g_pConsoleFont;
////////////////////////////////////////////////////////////////////////////////////////////////////
static void DrawChar(const int tileX, const int tileY, const uint8_t colorID, const uint8_t symbol)
{
    //const uint8_t *g_pCharTable = (const uint8_t *)g_pConsoleFont;
    //static uint8_t *g_pCharTable = (uint8_t *)g_pConsoleFont;
    const int dstWidth = SCREEN_SIZE_X >> 2;
    const int dWordX = tileX << 1;
    const int pixelY = tileY << 3;
    uint32_t *pBuffer = r_GetScreenBuffer();
    //const int symbolOffset = symbol << 3;

    /*
    uint8_t symbolBitMask[8] =
    {
        0x00,
        0x18,
        0x24,
        0x42,
        0x42,
        0x24,
        0x18,
        0x00
    };
    */
    




    for( int y = 0; y < 8; ++y )
    {
        //const uint8_t charCode = g_pCharTable[y];
        //uint64_t charCode = g_pCharTable[symbolOffset + y];

        for( int dw = 0; dw < 2; ++dw)
        {
            const int dstOffset = dstWidth * ( y + pixelY ) + dw + dWordX;
            uint32_t dstDWord = pBuffer[dstOffset];
            for( int i = 0; i < 4; ++i )
            {
                int shift = i << 3;
                int x = dw * 4 + i;

                // Find char byte
                int screenPixelX = tileX * 8 + x;
                int screenPixelY = tileY * 8 + y;
                int screenPixelOffset = screenPixelY * 128 + screenPixelX;
                //int symbolOffset = (screenPixelOffset / 8);

                const int symbolOffset = symbol * 8 + y;

                uint16_t charCode = g_pCharTable[symbolOffset];
                //uint8_t charCode = g_pCharTable[symbol * 8];
                //uint8_t charCode = g_pCharTable[y];

                
                

                // Should we put pixel
                //const int bitOffset = x;
                uint16_t bitMask = 1 << x;
                uint16_t result = charCode & bitMask;
                if( result > 0 )
                {
                    uint32_t byteMask = ~( 0xFF << shift );
                    int newByte = colorID << shift;
                    dstDWord &= byteMask;
                    dstDWord |= newByte;
                }
            }

            pBuffer[dstOffset] = dstDWord;
        }
    }

    /*

    const int symbolOffset = symbol * 8;
    for( int y = 0; y < 8; ++y )
    {
        uint8_t charCode = g_pCharTable[symbolOffset + y];
        for( int i = 0; i < 8; ++i )
        {
            const uint8_t mask = 1 << i;
        }

        for( int dw = 0; dw < 2; ++dw)
        {
            const int dstOffset = dstWidth * y + dw;
            uint32_t dstDWord = pBuffer[dstOffset];
            

            

            // TODO: Modify dstWord

            pBuffer[dstOffset] = 0x10101010;//dstDWord;
        }
    }
    */

}
////////////////////////////////////////////////////////////////////////////////////////////////////
void c_ConsoleLog(const int tileX, const int tileY, const int colorID, const char *pFormat)//, ...)
{
    /*
    char message[MAX_MESSAGE_SIZE];


	va_list v;
	va_start(v,pFormat);
	
	vsprintf(message, pFormat, v);
	
	va_end(v);

    int len = strlen(message);
    for( int i = 0; i < len; ++i )
        DrawChar(tileX + i, tileY, colorID, message[i]);
        */

    //int len = strlen(pFormat);
    //for( int i = 0; i < len; ++i )
    /*
    for( int i = 0; i < 10; ++i )
        DrawChar(tileX + i, tileY, colorID, 0);//pFormat[i]);
        */

    for( int y = 0; y < 16; ++y )
        for( int x = 0; x < 16; ++x)
        {
            DrawChar(x, y, colorID, 16 * y + x);

        }




       /*
    int len = strlen(pFormat);
    for( int i = 0; i < len; ++i )
        DrawChar(tileX + i, tileY, colorID, pFormat[i]);
        */
}
////////////////////////////////////////////////////////////////////////////////////////////////////